#!/usr/bin/env bash
set -euo pipefail

BASHRC="$HOME/.bashrc"
ZSHRC="$HOME/.zshrc"
START="# >>> customrc >>>"
END="# <<< customrc <<<"

CUSTOM_BLOCK=$(cat <<EOF
$START
# Generated by $(pwd)/customrc

$(tail -n +2 ./customrc)
$END
EOF
)

normalize() {
  local content="$1"
  printf '%s\n' "$content" | \
    sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' -e '/^$/d' | \
    sha256sum | \
    awk '{print $1}'
}

update_shell_config() {
  local shell_file="$1"
  local shell_name="$2"
  
  if [[ ! -f "$shell_file" ]]; then
    echo "$shell_name not found, skipping..."
    return
  fi

  existing=$(awk -v start="$START" -v end="$END" '
    $0 == start {flag=1}
    flag {print}
    $0 == end {flag=0}
  ' "$shell_file" 2>/dev/null || true)

  existing_hash=$(normalize "$existing")
  custom_hash=$(normalize "$CUSTOM_BLOCK")

  if [[ "$existing_hash" != "$custom_hash" ]]; then
    # Remove old block (including markers) if present
    awk -v start="$START" -v end="$END" 'BEGIN{skip=0} 
      $0 == start {skip=1} 
      !skip {print} 
      $0 == end {skip=0; next}' "$shell_file" > "$shell_file.tmp"

    # Append new block
    printf '\n%s\n' "$CUSTOM_BLOCK" >> "$shell_file.tmp"

    # Replace shell config file
    mv "$shell_file.tmp" "$shell_file"
    echo "Updated customrc block in $shell_name"
  else
    echo "customrc block is already up to date in $shell_name"
  fi
}

# Update both .bashrc and .zshrc
update_shell_config "$BASHRC" ".bashrc"
update_shell_config "$ZSHRC" ".zshrc"

